@startuml Change Password Flow
title Change Password Flow
actor User
boundary UI
control "User Service" as Service
database DB

User -> UI: Click Change Password
UI --> User: Show Change Password Form
User -> UI: Enter Old Password, New Password, Confirm New Password

' Client-side prechecks (format/match)
alt New password invalid format
    UI --> User: 400 Bad Request (password format invalid)
else New password and confirm mismatch
    UI --> User: 400 Bad Request (passwords mismatch)
else Proceed to send request
    UI -> Service: Request Change Password (oldPassword, newPassword)
    activate Service

    Service -> DB: Query: validate user credentials (userId, oldPassword)
    DB --> Service: QueryResult (valid / invalid / user not found)

    alt Credentials valid
        Service -> DB: Update password (atomic transaction)
        DB --> Service: QueryResult (update success / conflict)
        alt Update success
            Service --> UI: 200 OK (Change password success)
            UI --> User: Show success message
        else Update failed (concurrent update / constraint)
            Service --> UI: 409 Conflict or 412 Precondition Failed (version)
            UI --> User: Show conflict message
        end
    else Credentials invalid
        Service --> UI: 401 Unauthorized (Old password incorrect / session expired)
        UI --> User: Show error (reauthenticate)
    end
    deactivate Service
end

alt Rate / infra / mail errors
    alt 429 Too Many Requests
        Service --> UI: 429 (Rate limit)
    else DB timeout / connection error
        Service --> UI: 503/504 Service Unavailable
    else Unexpected server error
        Service --> UI: 500 Internal Server Error
    end
    UI --> User: Display error message
end
@enduml